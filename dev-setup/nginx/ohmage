# Tomcat app server
upstream ohmage {
  server 127.0.0.1:8080 fail_timeout=10s;
}

server {
        listen 80;
        root /var/www/ohmage;
        index index.html;

        server_name localhost;

        # Proxy ohmage server requests to local Tomcat.
        location /ohmage {
         proxy_pass http://ohmage;
         proxy_set_header X-Real-IP $remote_addr;
         proxy_set_header        X-Forwarded-For $proxy_add_x_forwarded_for;
         proxy_set_header        Host $http_host;
         proxy_read_timeout 300s;
        }

        # Proxy anything that shouldn't go to the ohmage server back through ember.
        # This allows for permalinks to web views (e.g., viewing a specific survey).
        location / {
          try_files $uri $uri/ /index.html?/$request_uri;
        }

        # Deny access to legacy Tomcat servlet dirs and any .git dir
        location ~ /\WEB-INF {
                deny all;
        }
        location ~ /\META-INF {
                deny all;
        }
        location ~ /\.git {                deny all;
        }
}