<beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xmlns:util="http://www.springframework.org/schema/util"
       xsi:schemaLocation="http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-2.5.xsd
                           http://www.springframework.org/schema/util http://www.springframework.org/schema/util/spring-util-2.5.xsd">
  <!--  
     Spring ApplicationContext configuration for survey data upload 
  -->
  
  <!-- Servlet-to-AW hooks -->
  <!-- create AwRequest from data in the HttpServletRequest -->
  <bean id="surveyUploadAwRequestCreator" class="org.ohmage.jee.servlet.glue.SurveyUploadAwRequestCreator" />
  
  <!-- validate parameters in the http request -->
  <bean id="surveyUploadHttpServletRequestValidator" class="org.ohmage.jee.servlet.validator.SurveyUploadValidator" />
  
  <!-- the response writer is shared with mobilityUploadController.xml -->
  
  <!-- 
    Controller - main workflow: authentication, deep message validation, tranformation of uploaded JSON and prep for database,
    insertion into database.
  -->
  <bean id="surveyUploadController" class="org.ohmage.controller.ControllerImpl">
    <constructor-arg index="0">
    <!-- service the upload request -->
      <list>
      
        <!-- authenticate -->
        <ref bean="authWithHashedPasswordService" />
        
        <!-- authorize -->
        <ref bean="userRoleCampaignPopulationService" />
        <ref bean="userCampaignValidationService" />
        <ref bean="participantUserRoleValidationService" />
        <ref bean="campaignRunningStateValidationService" />
        <ref bean="campaignCreationTimeValidationService" />
        
        <!-- grab the XML config from the db -->
        <ref bean="findCampaignConfigurationService" />
        
        <!-- validate the upload -->
        <!-- JSON validation: deep specification validation -->
        <ref bean="jsonMessageSyntaxValidationService" />
        <ref bean="surveyMessageContentValidationService" />
        
        <!-- convert JSON into DataPackets -->
        <ref bean="surveyDataPacketBuilderService" />
        
        <!-- persist DataPackets into db -->
        <ref bean="surveyDataStorageService" />
        
      </list>
    </constructor-arg>
    <constructor-arg index="1">
      <ref bean="serverErrorRequestAnnotator" />
    </constructor-arg>
    <property name="validators">
      <list>
        <ref bean="userNameValidator" />
        <ref bean="hashedPasswordValidator" />
      </list>
    </property>
    <property name="postProcessingService">
      <!-- log upload stats, the upload itself, any failed upload info, and duplicates to the filesystem -->  
      <bean id="messageLoggerService" class="org.ohmage.service.MessageLoggerService">
        <constructor-arg index="0">
          <value>survey</value>
        </constructor-arg>
      </bean>
    </property>
    <property name="featureName"><value>survey upload</value></property>
  </bean>
  
  <bean id="userRoleCampaignPopulationService" class="org.ohmage.service.UserRoleCampaignPopulationService">
    <constructor-arg index="0">
      <bean class="org.ohmage.validator.json.FailedJsonRequestAnnotator">
        <constructor-arg index="0">
           <bean class="org.ohmage.domain.ErrorResponse">
            <property name="code" value="0205" />
            <property name="text" value="User doesn't belong to any campaigns." />
          </bean>
        </constructor-arg>
      </bean>
    </constructor-arg>
    <constructor-arg index="1">
      <bean class="org.ohmage.dao.UserRoleCampaignPopulationDao">
        <constructor-arg index="0">
          <ref bean="dataSource" />
        </constructor-arg>
      </bean>
    </constructor-arg>
  </bean>
  
  <bean id="userCampaignValidationService" class="org.ohmage.service.UserCampaignValidationService">
     <constructor-arg index="0">
      <bean class="org.ohmage.validator.json.FailedJsonRequestAnnotator">
        <constructor-arg index="0">
           <bean class="org.ohmage.domain.ErrorResponse">
            <property name="code" value="0604" />
            <property name="text" value="user not in campaign" />
          </bean>
        </constructor-arg>
      </bean>
    </constructor-arg>
  </bean>

  <bean id="participantUserRoleValidationService" class="org.ohmage.service.UserRoleValidationService">
     <constructor-arg index="0">
      <bean class="org.ohmage.validator.json.FailedJsonRequestAnnotator">
        <constructor-arg index="0">
           <bean class="org.ohmage.domain.ErrorResponse">
            <property name="code" value="0607" />
            <property name="text" value="user has invalid role for this operation" />
          </bean>
        </constructor-arg>
      </bean>
    </constructor-arg>
    <constructor-arg index="1">
        <list><value>participant</value></list>
    </constructor-arg>
  </bean>
  
  <bean id="campaignRunningStateValidationService" class="org.ohmage.service.CampaignRunningStateValidationService">
     <constructor-arg index="0">
      <bean class="org.ohmage.validator.json.FailedJsonRequestAnnotator">
        <constructor-arg index="0">
           <bean class="org.ohmage.domain.ErrorResponse">
            <property name="code" value="0608" />
            <property name="text" value="campaign is not running so uploads cannot be accepted" />
          </bean>
        </constructor-arg>
      </bean>
    </constructor-arg>
    <constructor-arg index="1">
      <ref bean="campaignStateDao" />
    </constructor-arg>
    <constructor-arg index="2">
        <value>running</value>
    </constructor-arg>
  </bean>
  
  <bean id="campaignCreationTimeValidationService" class="org.ohmage.service.CampaignCreationTimeValidationService">
     <constructor-arg index="0">
      <bean class="org.ohmage.validator.json.FailedJsonRequestAnnotator">
        <constructor-arg index="0">
           <bean class="org.ohmage.domain.ErrorResponse">
            <property name="code" value="0609" />
            <property name="text" value="campaign is out of date" />
          </bean>
        </constructor-arg>
      </bean>
    </constructor-arg>
  </bean>
  
  <bean id="campaignStateDao" class="org.ohmage.dao.CampaignStateDao">
     <constructor-arg index="0">
       <ref bean="dataSource" />
     </constructor-arg>
  </bean>
  
  <!-- Validate JSON content according to app business rules -->
  <bean id="surveyMessageContentValidationService" class="org.ohmage.service.JsonMessageContentValidationService">
    <constructor-arg index="0">
      <list>
        <ref bean="jsonMsgDateValidator" />
        <ref bean="jsonMsgTimeValidator" />
        <ref bean="jsonMsgTimezoneValidator" />
        <ref bean="jsonMsgLocationStatusValidator" />
        <ref bean="jsonMsgLocationValidator" />
        <ref bean="jsonMsgSurveyIdValidator" />
        <ref bean="jsonMsgSurveyResponsesExistValidator" />
        <ref bean="jsonMsgSurveyLaunchContextValidator" />
        <ref bean="jsonMsgSurveyResponsesValidator" />
      </list>
    </constructor-arg>
    <constructor-arg index="1"><ref bean="jsonMsgEmptyArrayAnnotator" /></constructor-arg>
    <constructor-arg index="2"><ref bean="jsonMsgIncorrectArrayAnnotator" /></constructor-arg>
  </bean>
  
  <bean id="jsonMsgSurveyIdValidator" class="org.ohmage.validator.survey.JsonMsgSurveyIdValidator">
    <constructor-arg index="0">
      <bean class="org.ohmage.validator.json.FailedJsonRequestAnnotator">
        <constructor-arg index="0">
          <bean class="org.ohmage.domain.ErrorResponse">
            <property name="code" value="0605" />
            <property name="text" value="missing or invalid survey_id in message" />
          </bean>
        </constructor-arg>  
      </bean>
    </constructor-arg>
  </bean>
  
  <bean id="jsonMsgSurveyResponsesExistValidator" class="org.ohmage.validator.survey.JsonMsgSurveyResponsesExistValidator">
    <constructor-arg index="0">
      <bean class="org.ohmage.validator.json.FailedJsonRequestAnnotator">
        <constructor-arg index="0">
          <bean class="org.ohmage.domain.ErrorResponse">
            <property name="code" value="0602" />
            <property name="text" value="missing responses in survey message" />
          </bean>
        </constructor-arg>  
      </bean>
    </constructor-arg>
  </bean>
  
  <bean id="jsonMsgSurveyResponsesValidator" class="org.ohmage.validator.survey.JsonMsgSurveyResponsesValidator">
    <constructor-arg index="0">
      <bean class="org.ohmage.validator.json.FailedJsonRequestAnnotator">
        <constructor-arg index="0">
          <bean class="org.ohmage.domain.ErrorResponse">
            <property name="code" value="0603" />
            <property name="text" value="invalid prompt response" />
          </bean>
        </constructor-arg>  
      </bean>
    </constructor-arg>
    <constructor-arg index="1">
      <ref bean="promptValidatorCache" />
    </constructor-arg>
  </bean>
  
  <bean id="jsonMsgSurveyLaunchContextValidator" class="org.ohmage.validator.survey.JsonMsgSurveyLaunchContextValidator">
    <constructor-arg index="0">
      <bean class="org.ohmage.validator.json.FailedJsonRequestAnnotator">
        <constructor-arg index="0">
          <bean class="org.ohmage.domain.ErrorResponse">
            <property name="code" value="0606" />
            <property name="text" value="missing or incorrect survey_launch_context in survey message" />
          </bean>
        </constructor-arg>  
      </bean>
    </constructor-arg>
  </bean>
  
  <bean id="jsonMsgLocationStatusValidator" class="org.ohmage.validator.json.JsonMsgValueInListValidator">
    <constructor-arg index="0">
      <bean class="org.ohmage.validator.json.FailedJsonRequestAnnotator">
        <constructor-arg index="0">
          <bean class="org.ohmage.domain.ErrorResponse">
            <property name="code" value="0408" />
            <property name="text" value="invalid location status" />
          </bean>
        </constructor-arg>  
      </bean>
    </constructor-arg>
    <constructor-arg index="1">
      <value>location_status</value>
    </constructor-arg>
    <constructor-arg index="2">
      <ref bean="surveyLocationStatuses" />
    </constructor-arg>
  </bean>
  
   <util:list id="surveyLocationStatuses">
    <value>unavailable</value>
    <value>valid</value>
    <value>inaccurate</value>
    <value>stale</value>
  </util:list>
  
  <bean id="jsonMsgLocationValidator" class="org.ohmage.validator.survey.JsonMsgLocationValidator">
    <constructor-arg index="0">
      <bean class="org.ohmage.validator.json.FailedJsonRequestAnnotator">
        <constructor-arg index="0">
          <bean class="org.ohmage.domain.ErrorResponse">
            <property name="code" value="0409" />
            <property name="text" value="location existence problem" />
          </bean>
        </constructor-arg>  
      </bean>
    </constructor-arg>
    <constructor-arg index="1">
      <list>
        <ref bean="jsonMsgLatitudeValidator" />
        <ref bean="jsonMsgLongitudeValidator" />
        <ref bean="jsonMsgLocationAccuracyValidator" />
        <ref bean="jsonMsgLocationProviderValidator" />
        <ref bean="jsonMsgLocationTimestampValidator" />
      </list>
    </constructor-arg>
  </bean>      
  
  <bean id="jsonMsgLocationTimestampValidator" class="org.ohmage.validator.json.JsonMsgLocationTimestampValidator">
    <constructor-arg index="0">
      <bean class="org.ohmage.validator.json.FailedJsonRequestAnnotator">
        <constructor-arg index="0">
          <bean class="org.ohmage.domain.ErrorResponse">
            <property name="code" value="0410" />
            <property name="text" value="missing or invalid timestamp" />
          </bean>
        </constructor-arg>  
      </bean>
    </constructor-arg>
  </bean>
  
  <bean id="promptValidatorCache" class="org.ohmage.validator.prompt.PromptValidatorCache">
    <constructor-arg index="0">
      <map>
        <entry>
          <key><value>hours_before_now</value></key>
          <bean class="org.ohmage.validator.prompt.RangeBoundNumberPromptValidator" />
        </entry>
        <entry>
          <key><value>number</value></key>
          <bean class="org.ohmage.validator.prompt.RangeBoundNumberPromptValidator" />
        </entry>
        <entry>
          <key><value>timestamp</value></key>
          <bean class="org.ohmage.validator.prompt.TimestampPromptValidator" />
        </entry>
        <entry>
          <key><value>text</value></key>
          <bean class="org.ohmage.validator.prompt.TextWithinRangePromptValidator" />
        </entry>
        <entry>
          <key><value>multi_choice</value></key>
          <bean class="org.ohmage.validator.prompt.MultiChoicePromptValidator" />
        </entry>
        <entry>
          <key><value>multi_choice_custom</value></key>
          <bean class="org.ohmage.validator.prompt.MultiChoiceCustomPromptValidator" />
        </entry>
        <entry>
          <key><value>single_choice</value></key>
          <bean class="org.ohmage.validator.prompt.SingleChoicePromptValidator" />
        </entry>
        <entry>
          <key><value>single_choice_custom</value></key>
          <bean class="org.ohmage.validator.prompt.SingleChoiceCustomPromptValidator" />
        </entry>
        <entry>
          <key><value>photo</value></key>
          <bean class="org.ohmage.validator.prompt.UUIDPromptValidator" />
        </entry>
        <entry>
          <key><value>remote_activity</value></key>
          <bean class="org.ohmage.validator.prompt.RemoteActivityPromptValidator" />
        </entry>
      </map>
    </constructor-arg>
  </bean>
  
  <bean id="surveyDataPacketBuilderService" class="org.ohmage.service.SurveyDataPacketBuilderService">
    <constructor-arg index="0">
      <bean class="org.ohmage.domain.SurveyDataPacketBuilder" />
    </constructor-arg>
  </bean>
  
  <bean id="surveyDataStorageService" class="org.ohmage.service.DaoService" >
    <constructor-arg index="0">
      <bean class="org.ohmage.dao.SurveyUploadDao">
        <constructor-arg index="0"><ref bean="dataSource" /></constructor-arg>
      </bean>
    </constructor-arg>
  </bean>
  
</beans>