<beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xsi:schemaLocation="http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-2.5.xsd
                           http://www.springframework.org/schema/util http://www.springframework.org/schema/util/spring-util-2.5.xsd">
  <!--  
     Spring ApplicationContext configuration for sensor (phone) data upload 
  -->
  
  <!-- Servlet-to-AW hooks -->
  <!-- create AwRequest from data in the HttpServletRequest -->
  <bean id="sensorUploadAwRequestCreator" class="edu.ucla.cens.awserver.jee.servlet.glue.SensorUploadAwRequestCreator" />
  
  <!-- Controller - main workflow -->
  <bean id="sensorUploadController" class="edu.ucla.cens.awserver.controller.ControllerImpl">
    <constructor-arg index="0">
      <list>
        <ref bean="emptySubdomainValidator" />
        <ref bean="sensorUploadUserNameValidator" />
        <ref bean="sensorUploadRequestTypeValidator" />
        <ref bean="sensorUploadPhoneVersionValidator" />
        <ref bean="sensorUploadProtocolVersionValidator" />
        <ref bean="sensorUploadJsonDataExistsValidator" />
      </list>
    </constructor-arg>
    <constructor-arg index="1">
      <list>
        <ref bean="sensorUploadAuthenticationService" />
        <ref bean="jsonMessageSourceInfoService" />
        <ref bean="jsonMessageSyntaxValidationService" />
        <ref bean="jsonMessageContentValidationService" />
      </list>
    </constructor-arg>
  </bean>
  
  <!-- Service the upload request -->
  <bean id="sensorUploadAuthenticationService" class="edu.ucla.cens.awserver.service.AuthenticationService">
    <constructor-arg index="0">
      <ref bean="authenticationDao" />
    </constructor-arg>
    <constructor-arg index="1">
      <ref bean="sensorUploadFailedJsonRequestAnnotator" />
    </constructor-arg>
    <constructor-arg index="2"><value>{"errors":[{"error_code":"0200","error_text":"unknown username"}]}</value></constructor-arg>
    <constructor-arg index="3"><value>{"errors":[{"error_code":"0199","error_text":"disabled user"}]}</value></constructor-arg>
  </bean>
  
  <bean id="jsonMessageSyntaxValidationService" class="edu.ucla.cens.awserver.service.JsonMessageSyntaxValidationService">
    <constructor-arg index="0">
      <bean class="edu.ucla.cens.awserver.validator.FailedJsonRequestAnnotator">
        <constructor-arg index="0">
          <value>{"errors":[{"error_code":"0101","error_text":"JSON syntax error"}]}</value>
        </constructor-arg>
      </bean>
    </constructor-arg>   
  </bean>
  
  <!--  Annotate the AwRequest in the case of failed authentication -->	
  <bean id="sensorUploadFailedJsonRequestAnnotator" class="edu.ucla.cens.awserver.validator.FailedJsonSuppliedMessageRequestAnnotator" />
  
  <bean id="jsonMessageSourceInfoService" class="edu.ucla.cens.awserver.service.JsonMessageSourceInfoService" />
  
  <bean id="jsonMessageContentValidationService" class="edu.ucla.cens.awserver.service.JsonMessageContentValidationService">
  	<constructor-arg index="0">
  	  <map>
  	    <entry>
  	      <key><value>mobility</value></key>
  	      <list>
  	        <ref bean="jsonMsgMobilitySubtypeValidator" />
  	      </list>
  	    </entry><!-- 
  	    <entry>
  	      <key><value>prompt</value></key>
  	      <list>
  	        <ref bean="..." />
  	      </list>
  	    </entry> -->
  	  </map>
  	</constructor-arg>
    <constructor-arg index="1"><ref bean="jsonMsgEmptyArrayAnnotator" /></constructor-arg>
    <constructor-arg index="2"><ref bean="jsonMsgIncorrectArrayAnnotator" /></constructor-arg>
  </bean>
  
  <bean id="jsonMsgEmptyArrayAnnotator" class="edu.ucla.cens.awserver.validator.FailedJsonRequestAnnotator">
    <constructor-arg index="0">
      <value>{"errors":[{"error_code":"0102","error_text":"no data in message - empty JSON array"}]}</value>
    </constructor-arg>   
  </bean>
   
  <bean id="jsonMsgIncorrectArrayAnnotator" class="edu.ucla.cens.awserver.validator.FailedJsonRequestAnnotator">
    <constructor-arg index="0">
      <value>{"errors":[{"error_code":"0103","error_text":"incorrect array entry - not a JSON Object"}]}</value>
    </constructor-arg>   
  </bean>
  
  <bean id="jsonMsgMobilitySubtypeValidator" class="edu.ucla.cens.awserver.validator.JsonMsgMobilitySubtypeValidator">
    <constructor-arg index="0">
      <bean class="edu.ucla.cens.awserver.validator.FailedJsonRequestAnnotator">
        <constructor-arg index="0">
          <value>{"errors":[{"error_code":"0500","error_text":"missing or invalid subtype"}]}</value>
        </constructor-arg>
      </bean>
    </constructor-arg>
    <constructor-arg index="1">
      <map>
        <entry>
          <key><value>mode_only</value></key>
          <list>
            <ref bean="jsonMsgDateValidator" />
            <ref bean="jsonMsgTimeValidator" />
            <ref bean="jsonMsgTimezoneValidator" />
          </list>
        </entry>
        <entry>
          <key><value>mode_features</value></key>
          <list>
            <ref bean="jsonMsgDateValidator" />
            <ref bean="jsonMsgTimeValidator" />
            <ref bean="jsonMsgTimezoneValidator" />
          </list>
        </entry>
      </map>
    </constructor-arg>
  </bean>
  
  <bean id="jsonMsgDateValidator" class="edu.ucla.cens.awserver.validator.JsonMsgDateValidator">
    <constructor-arg index="0">
      <bean class="edu.ucla.cens.awserver.validator.FailedJsonRequestAnnotator">
        <constructor-arg index="0">
          <value>{"errors":[{"error_code":"0401","error_text":"missing or invalid date"}]}</value>
        </constructor-arg>   
      </bean>
    </constructor-arg>
  </bean>
  
  <bean id="jsonMsgTimeValidator" class="edu.ucla.cens.awserver.validator.JsonMsgTimeValidator">
    <constructor-arg index="0">
      <bean class="edu.ucla.cens.awserver.validator.FailedJsonRequestAnnotator">
        <constructor-arg index="0">
          <value>{"errors":[{"error_code":"0402","error_text":"missing or invalid time"}]}</value>
        </constructor-arg>  
      </bean>
    </constructor-arg>
  </bean>

  <bean id="jsonMsgTimezoneValidator" class="edu.ucla.cens.awserver.validator.JsonMsgTimezoneValidator">
    <constructor-arg index="0">
      <bean class="edu.ucla.cens.awserver.validator.FailedJsonRequestAnnotator">
        <constructor-arg index="0">
          <value>{"errors":[{"error_code":"0403","error_text":"missing or invalid timezone"}]}</value>
        </constructor-arg>  
      </bean>
    </constructor-arg>
  </bean>
  
</beans>